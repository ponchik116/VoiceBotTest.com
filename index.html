<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Голос → Перевод → Озвучивание</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px}
    button{padding:8px 12px;margin:6px;font-size:15px}
    select,input{font-size:14px;margin-left:6px}
    #status{margin-top:10px}
    #log{margin-top:12px;padding:10px;border:1px solid #ddd;min-height:70px;white-space:pre-wrap}
  </style>
</head>
<body>
  <h2>Говорите по‑русски → перевод и озвучивание на выбранном языке</h2>

  <div>
    <button id="startBtn">Начать</button>
    <button id="stopBtn" disabled>Остановить</button>

    <label style="margin-left:12px">
      Целевой язык:
      <select id="targetLang">
        <option value="en">Английский (en)</option>
        <option value="es">Испанский (es)</option>
        <option value="de">Немецкий (de)</option>
        <option value="fr">Французский (fr)</option>
        <option value="it">Итальянский (it)</option>
        <option value="pt">Португальский (pt)</option>
      </select>
    </label>

    <label style="margin-left:12px">
      Голос:
      <select id="voiceSelect"></select>
    </label>
  </div>

  <div id="status">Статус: ожидаю</div>
  <div id="log" aria-live="polite"></div>

<script>
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');
const log = document.getElementById('log');
const voiceSelect = document.getElementById('voiceSelect');
const targetLang = document.getElementById('targetLang');

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  status.textContent = 'SpeechRecognition не поддерживается в этом браузере.';
  startBtn.disabled = true;
}
let recognition = SpeechRecognition ? new SpeechRecognition() : null;
if (recognition) {
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.continuous = false;
}

let voices = [];
let selectedVoiceName = null;

function logMsg(s) {
  log.textContent = `${new Date().toLocaleTimeString()} — ${s}\n` + log.textContent;
}

function loadVoices() {
  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = '';
  // фильтруем голоса подходящие по языку целевого (покажем все, пользователь выберет)
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
    voiceSelect.appendChild(opt);
  });
  if (selectedVoiceName) {
    const found = voices.find(v => v.name === selectedVoiceName);
    if (found) voiceSelect.value = selectedVoiceName;
  } else if (voices.length) {
    selectedVoiceName = voices[0].name;
    voiceSelect.value = selectedVoiceName;
  }
}
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
voiceSelect.addEventListener('change', () => { selectedVoiceName = voiceSelect.value; });

// Функция вызова бесплатного перевода (LibreTranslate demo). При проблемах замените на свой endpoint.
async function translateText(text, target) {
  try {
    const res = await fetch('https://libretranslate.com/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ q: text, source: 'ru', target: target, format: 'text' })
    });
    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();
    return data.translatedText;
  } catch (e) {
    console.warn('translate error', e);
    return null;
  }
}

// Воспроизведение перевода
function speak(text, lang, cb) {
  if (!text) { if (cb) cb(); return; }
  const utter = new SpeechSynthesisUtterance(text);
  // пытаемся подобрать голос, соответствующий целевому языку
  const allVoices = speechSynthesis.getVoices() || [];
  let voice = allVoices.find(v => v.name === selectedVoiceName);
  if (!voice) {
    // попробуем выбрать голос по lang prefix (например en, es)
    voice = allVoices.find(v => v.lang && v.lang.toLowerCase().startsWith(lang));
  }
  if (voice) utter.voice = voice;
  utter.lang = lang;
  utter.rate = 1;
  utter.pitch = 1;
  utter.onend = () => { if (cb) cb(); };
  utter.onerror = () => { if (cb) cb(); };
  speechSynthesis.speak(utter);
}

// Основная логика распознавания -> перевод -> озвучивание
if (recognition) {
  recognition.onstart = () => {
    status.textContent = 'Слушаю...';
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };
  recognition.onend = () => {
    status.textContent = 'Остановлено';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };
  recognition.onerror = (e) => {
    console.warn(e);
    status.textContent = 'Ошибка распознавания';
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };
  recognition.onresult = async (evt) => {
    const text = evt.results[0][0].transcript.trim();
    logMsg('Распознано (RU): ' + text);
    status.textContent = 'Перевожу...';
    const tgt = targetLang.value;
    const translated = await translateText(text, tgt);
    if (!translated) {
      status.textContent = 'Ошибка перевода';
      logMsg('Ошибка перевода или сервис недоступен.');
      return;
    }
    logMsg(`Перевод (${tgt}): ${translated}`);
    status.textContent = 'Озвучиваю...';
    // назначаем язык для синтеза (например 'en-US' для en) — простая карта:
    const langMap = { en: 'en-US', es: 'es-ES', de: 'de-DE', fr: 'fr-FR', it: 'it-IT', pt: 'pt-PT' };
    const synthLang = langMap[tgt] || tgt;
    speak(translated, synthLang, () => {
      status.textContent = 'Готово';
    });
  };
}

// Кнопки
startBtn.addEventListener('click', async () => {
  if (!recognition) return;
  log.textContent = '';
  status.textContent = 'Готовлюсь...';
  // дождёмся голосов
  await new Promise(r => {
    loadVoices();
    if (voices.length) return r();
    const h = () => { loadVoices(); if (voices.length) { speechSynthesis.removeEventListener('voiceschanged', h); r(); } };
    speechSynthesis.addEventListener('voiceschanged', h);
    setTimeout(() => { speechSynthesis.removeEventListener('voiceschanged', h); r(); }, 2000);
  });
  try {
    recognition.start();
  } catch(e) {
    console.warn(e);
  }
});
stopBtn.addEventListener('click', () => {
  try { recognition.stop(); } catch(e) {}
  speechSynthesis.cancel();
  status.textContent = 'Остановлено вручную';
  startBtn.disabled = false;
  stopBtn.disabled = true;
});
</script>
</body>
</html>
