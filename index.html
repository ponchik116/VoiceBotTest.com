<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Голосовой переводчик</title>
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Arial;
      margin: 28px;
      background-color: #f5f5f7;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #2c3e50;
      margin-top: 0;
    }
    button {
      font-size: 16px;
      padding: 10px 16px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    #startBtn {
      background-color: #4CAF50;
      color: white;
    }
    #startBtn:hover {
      background-color: #45a049;
    }
    #stopBtn {
      background-color: #f44336;
      color: white;
    }
    #stopBtn:hover {
      background-color: #d32f2f;
    }
    button:disabled {
      background-color: #cccccc;
      color: #666666;
      cursor: not-allowed;
    }
    .select-group {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      min-width: 200px;
    }
    label {
      font-weight: 500;
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      background-color: #f8f9fa;
      border-left: 4px solid #6c757d;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      min-height: 100px;
      white-space: pre-wrap;
      border-radius: 8px;
      background-color: #f8f9fa;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .timestamp {
      color: #6c757d;
      font-size: 0.85em;
    }
    .original {
      color: #2c3e50;
      font-weight: 500;
    }
    .translated {
      color: #27ae60;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Голосовой переводчик</h2>
    <p>Говорите на русском, а система переведет и произнесет на выбранном языке</p>

    <div>
      <button id="startBtn">Начать запись</button>
      <button id="stopBtn" disabled>Остановить</button>
    </div>

    <div class="select-group">
      <div>
        <label for="voiceSelect">Голос для воспроизведения:</label>
        <select id="voiceSelect"></select>
      </div>
      <div>
        <label for="targetLang">Язык перевода:</label>
        <select id="targetLang">
          <option value="en">Английский</option>
          <option value="es">Испанский</option>
          <option value="fr">Французский</option>
          <option value="de">Немецкий</option>
          <option value="it">Итальянский</option>
          <option value="ja">Японский</option>
          <option value="zh">Китайский</option>
          <option value="ko">Корейский</option>
          <option value="ar">Арабский</option>
          <option value="hi">Хинди</option>
          <option value="pt">Португальский</option>
        </select>
      </div>
    </div>

    <div id="status">Статус: Ожидание начала записи</div>
    <div id="log"></div>
  </div>

<script>
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const status = document.getElementById('status');
const log = document.getElementById('log');
const voiceSelect = document.getElementById('voiceSelect');
const targetLangSelect = document.getElementById('targetLang');

let recognition;
let recognizing = false;
let stopRequested = false;

// Инициализация SpeechRecognition
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  status.textContent = 'Ваш браузер не поддерживает распознавание речи. Попробуйте Chrome или Edge.';
  startBtn.disabled = true;
} else {
  recognition = new SpeechRecognition();
  recognition.lang = 'ru-RU';
  recognition.interimResults = false;
  recognition.continuous = false;
}

// Загрузка голосов для синтеза речи
function loadVoices() {
  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = '';
  
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
    voiceSelect.appendChild(opt);
  });
  
  // Попытка выбрать русский голос по умолчанию
  const russianVoice = voices.find(v => v.lang.startsWith('ru'));
  if (russianVoice) {
    voiceSelect.value = russianVoice.name;
  } else if (voices.length) {
    voiceSelect.value = voices[0].name;
  }
}

// Инициализация голосов
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

// Логирование событий
function logMsg(original, translated, targetLang) {
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.innerHTML = `
    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
    <div>Распознано: <span class="original">${original}</span></div>
    <div>Перевод (${targetLangSelect.options[targetLangSelect.selectedIndex].text}): <span class="translated">${translated}</span></div>
  `;
  log.prepend(logEntry);
}

// Функция перевода текста с помощью бесплатного API
async function translateText(text, targetLang) {
  try {
    // Используем LibreTranslate - бесплатный API для перевода
    const response = await fetch(`https://libretranslate.de/translate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        q: text,
        source: 'ru',
        target: targetLang,
        format: 'text'
      })
    });
    
    if (!response.ok) {
      throw new Error('Ошибка перевода');
    }
    
    const data = await response.json();
    return data.translatedText;
  } catch (error) {
    console.error('Ошибка перевода:', error);
    
    // Fallback: используем простой словарь для основных фраз
    const simpleDictionary = {
      'en': {
        'привет': 'hello',
        'как дела': 'how are you',
        'спасибо': 'thank you',
        'пожалуйста': 'please',
        'да': 'yes',
        'нет': 'no'
      },
      'es': {
        'привет': 'hola',
        'как дела': 'cómo estás',
        'спасибо': 'gracias',
        'пожалуйста': 'por favor',
        'да': 'sí',
        'нет': 'no'
      },
      'fr': {
        'привет': 'bonjour',
        'как дела': 'comment ça va',
        'спасибо': 'merci',
        'пожалуйста': 's\'il vous plaît',
        'да': 'oui',
        'нет': 'non'
      }
    };
    
    const langDict = simpleDictionary[targetLang];
    if (langDict) {
      const lowerText = text.toLowerCase();
      return langDict[lowerText] || text;
    }
    
    return text;
  }
}

// Воспроизведение текста
function speakText(text, lang) {
  if (!text) return;
  
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = lang;
  
  const selectedVoice = voices.find(v => v.name === voiceSelect.value);
  if (selectedVoice) {
    utter.voice = selectedVoice;
  }
  
  utter.rate = 0.9;
  utter.pitch = 1;
  
  speechSynthesis.speak(utter);
}

// Обработчики распознавания речи
if (recognition) {
  recognition.onstart = () => {
    recognizing = true;
    status.textContent = 'Слушаю...';
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  recognition.onerror = (e) => {
    console.warn('Ошибка распознавания:', e);
    if (!stopRequested) {
      setTimeout(() => {
        try { recognition.start(); } catch(_) {}
      }, 500);
    }
  };

  recognition.onend = () => {
    recognizing = false;
    if (stopRequested) {
      status.textContent = 'Запись остановлена';
      startBtn.disabled = false;
      stopBtn.disabled = true;
      return;
    }
    
    // Автоматически перезапускаем распознавание
    try { recognition.start(); } catch (e) {
      console.warn('Ошибка перезапуска:', e);
    }
  };

  recognition.onresult = async (evt) => {
    const result = evt.results[0][0];
    const transcript = result.transcript.trim();
    
    if (!transcript) return;
    
    const targetLang = targetLangSelect.value;
    status.textContent = 'Перевожу...';
    
    try {
      // Переводим текст
      const translatedText = await translateText(transcript, targetLang);
      
      // Логируем оригинал и перевод
      logMsg(transcript, translatedText, targetLang);
      
      // Произносим перевод
      speakText(translatedText, targetLang);
      
      status.textContent = 'Перевод завершен. Слушаю...';
    } catch (error) {
      console.error('Ошибка:', error);
      status.textContent = 'Ошибка перевода. Слушаю...';
      logMsg(transcript, 'Ошибка перевода', targetLang);
    }
  };
}

// Обработчики кнопок
startBtn.addEventListener('click', () => {
  if (!recognition) return;
  
  stopRequested = false;
  log.innerHTML = '';
  status.textContent = 'Запуск...';
  
  try {
    recognition.start();
  } catch(e) {
    console.warn('Ошибка запуска:', e);
    status.textContent = 'Ошибка запуска распознавания';
  }
});

stopBtn.addEventListener('click', () => {
  stopRequested = true;
  try {
    recognition.stop();
  } catch(e) {
    console.warn('Ошибка остановки:', e);
  }
  
  speechSynthesis.cancel();
  status.textContent = 'Остановлено';
  startBtn.disabled = false;
  stopBtn.disabled = true;
});
</script>
</body>
</html>
